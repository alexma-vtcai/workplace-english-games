<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocational English AI Coach (Auto-Detect)</title>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .status-box { background: #e8f0fe; color: #1a73e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; border: 1px solid #d2e3fc; }
        h1 { color: #2c3e50; text-align: center; }
        .scenario { background: #fff3cd; padding: 15px; border-left: 5px solid #ffc107; margin-bottom: 20px; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 2px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background: #28a745; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 18px; width: 100%; margin-top: 10px; }
        button:hover { background: #218838; }
        button:disabled { background: #bdc1c6; cursor: not-allowed; }
        #result { margin-top: 20px; padding: 20px; background: #fafafa; border: 1px solid #eee; display: none; line-height: 1.6; white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="container">
    <h1>è·æ¶¯è‹±èª AI å°å¸«</h1>

    <div id="status" class="status-box">
        ğŸ’¡ æº–å‚™å°±ç·’ã€‚é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•å°‹æ‰¾å¯ç”¨çš„ AI æ¨¡å‹ã€‚
    </div>

    <div class="scenario">
        <strong>ä»»å‹™ï¼šå›è¦†æŠ•è¨´ (Global Education Consultancy)</strong>
        <p>æƒ…å¢ƒï¼šå®¢æˆ¶ SunnyB æŠ•è¨´æ²’æ”¶åˆ° 10% æŠ˜æ‰£ã€‚è«‹è§£é‡‹æŠ˜æ‰£åªé©ç”¨æ–¼ 15 äººä»¥ä¸Šåœ˜é«”ï¼Œä¸¦æä¾›è¾¦å…¬æ™‚é–“ (Mon-Sat 9am-6pm)ã€‚</p>
    </div>

    <textarea id="studentResponse" placeholder="Type your response here..."></textarea>
    
    <button id="submitBtn" onclick="startProcess()">æäº¤æ‰¹æ”¹ (Auto-Connect)</button>
    
    <div id="result"></div>
</div>

<script>
    // âš ï¸ è«‹å¡«å…¥ä½ çš„ AI Studio API Key (AIza é–‹é ­)
    const API_KEY = "AIzaSyAoQDlOjh6gxQvYN5pn81hQR0Vjq8qrnUE"; 

    // ä¸»æµç¨‹
    async function startProcess() {
        const text = document.getElementById('studentResponse').value;
        const statusDiv = document.getElementById('status');
        const btn = document.getElementById('submitBtn');
        const resultDiv = document.getElementById('result');

        if (!text) { alert("è«‹è¼¸å…¥å…§å®¹ï¼"); return; }
        
        btn.disabled = true;
        resultDiv.style.display = 'none';
        statusDiv.innerHTML = "ğŸ”„ ç¬¬ä¸€æ­¥ï¼šæ­£åœ¨åµæ¸¬å¯ç”¨çš„æ¨¡å‹åç¨±...";

        try {
            // 1. å…ˆå• API æœ‰ä»€éº¼æ¨¡å‹å¯ç”¨
            const modelName = await findValidModel();
            
            if (!modelName) {
                throw new Error("æ‰¾ä¸åˆ°æ”¯æ´ generateContent çš„æ¨¡å‹ã€‚");
            }

            statusDiv.innerHTML = `âœ… æˆåŠŸé–å®šæ¨¡å‹ï¼š<strong>${modelName}</strong><br>ğŸ”„ ç¬¬äºŒæ­¥ï¼šæ­£åœ¨å‚³é€å­¸ç”Ÿä½œæ¥­é€²è¡Œåˆ†æ...`;

            // 2. ä½¿ç”¨æ‰¾åˆ°çš„æ¨¡å‹åç¨±é€²è¡Œæ‰¹æ”¹
            await generateFeedback(modelName, text);

        } catch (error) {
            statusDiv.innerHTML = `âŒ éŒ¯èª¤ï¼š${error.message}`;
            console.error(error);
        } finally {
            btn.disabled = false;
        }
    }

    // è¼”åŠ©å‡½å¼ 1ï¼šå°‹æ‰¾å¯ç”¨æ¨¡å‹
    async function findValidModel() {
        const listUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`;
        const response = await fetch(listUrl);
        const data = await response.json();

        if (data.error) {
            throw new Error(`åˆ—å‡ºæ¨¡å‹å¤±æ•— (${data.error.message})`);
        }

        // éæ¿¾é‚è¼¯ï¼šæ‰¾ä¸€å€‹æ”¯æ´ 'generateContent' ä¸”åç¨±åŒ…å« 'gemini' çš„æ¨¡å‹
        // å„ªå…ˆå°‹æ‰¾ 'flash' ç‰ˆæœ¬ï¼Œå› ç‚ºå®ƒæœ€å¿«ä¸”é€šå¸¸å…è²»é¡åº¦æœ€é«˜
        const validModels = data.models.filter(m => 
            m.supportedGenerationMethods.includes("generateContent") && 
            m.name.includes("gemini")
        );

        // å„ªå…ˆæ’åºï¼šFlash > Pro > 1.5 > 1.0
        const bestModel = validModels.find(m => m.name.includes("flash")) || validModels[0];

        if (bestModel) {
            // API å›å‚³çš„åç¨±é€šå¸¸æ˜¯ 'models/gemini-1.5-flash'ï¼Œæˆ‘å€‘ç›´æ¥ç”¨å®ƒ
            return bestModel.name.replace("models/", ""); 
        }
        return null;
    }

    // è¼”åŠ©å‡½å¼ 2ï¼šç”Ÿæˆå›é¥‹
    async function generateFeedback(modelName, studentText) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`;
        
        const prompt = `
            You are a strict Vocational English teacher. Analyze this email:
            """${studentText}"""
            
            Provide feedback in Traditional Chinese & English.
            Include: 
            1. Score (0-100)
            2. Check specific details: 15 students for discount? Mon-Sat 9am-6pm?
            3. Grammar & Tone check.
        `;

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
            })
        });

        const data = await response.json();
        
        if (data.error) throw new Error(data.error.message);

        const feedback = data.candidates[0].content.parts[0].text;
        
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = feedback.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        resultDiv.style.display = 'block';
        
        document.getElementById('status').innerHTML = "âœ¨ æ‰¹æ”¹å®Œæˆï¼";
    }
</script>

</body>
</html>
